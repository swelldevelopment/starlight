<?php
//*****************************************************************************
//*****************************************************************************
/**
 * Request Class
 *
 * @package		Starlight\API
 * @subpackage	Request
 * @author 		Christian J. Clark
 * @copyright	Copyright (c) Swell Development LLC
 * @link		http://www.swelldevelopment.com/
 **/
//*****************************************************************************
//*****************************************************************************

namespace Starlight\API\Request;

class Request
{
	//=========================================================================
    // Class Members
	//=========================================================================
    protected static $instance = false;
    protected static $vars = [];
    protected static $is_valid = true;
    protected static $content_type = false;
    protected static $request_type = false;

	//=========================================================================
	//=========================================================================
	// Constructor
	//=========================================================================
	//=========================================================================
    public function __construct()
    {
		//---------------------------------------------------------
        // Request Type
		//---------------------------------------------------------
		static::$request_type = (isset($_SERVER['REQUEST_METHOD'])) ? (strtoupper($_SERVER['REQUEST_METHOD'])) : ('GET');

		//---------------------------------------------------------
        // Set Content Type
		//---------------------------------------------------------
        if (array_key_exists('CONTENT_TYPE', $_SERVER)) {
            static::$content_type = strtolower($_SERVER['CONTENT_TYPE']);
        }

		//---------------------------------------------------------
        // IF JSON data was sent, validate it.
		//---------------------------------------------------------
        $input = file_get_contents('php://input');
        if ($input) {
            //---------------------------------------------------------
            // Allow ONLY JSON for from input
            //---------------------------------------------------------
            if (static::$content_type != 'application/json') {
                static::$is_valid = false;
            }
            $obj = json_decode($input, true);
            if (!$obj) {
                static::$is_valid = false;
            }
            else {
                static::$vars = $obj;
            }
        }
		//---------------------------------------------------------
        // Otherwise, use request data
		//---------------------------------------------------------
        else {
            static::$vars = $_REQUEST;
        }

		//---------------------------------------------------------
        // OPTIONS / HEAD are always valid
		//---------------------------------------------------------
        if (static::$request_type == 'OPTIONS') {
            static::$is_valid = true;
        }
    }

	//=========================================================================
	//=========================================================================
    // Get a Request Instance
	//=========================================================================
	//=========================================================================
    public static function instance()
    {
        if (!static::$instance) {
	        static::$instance = new static();
	    }
        return static::$instance;
    }

	//=========================================================================
	//=========================================================================
    // Test for request value existence
	//=========================================================================
	//=========================================================================
    public function __isset($index)
    {
        if (array_key_exists($index, static::$vars)) {
            return true;
        }
        return false;
    }

	//=========================================================================
	//=========================================================================
    // Get a value from the request
	//=========================================================================
	//=========================================================================
    public function __get($index)
    {
        if (array_key_exists($index, static::$vars)) {
            return static::$vars[$index];
        }
        return null;
    }

	//=========================================================================
	//=========================================================================
    // Get all request values
	//=========================================================================
	//=========================================================================
    public function GetAll()
    {
        return static::$vars;
    }

	//=========================================================================
	//=========================================================================
    // Get all request values
	//=========================================================================
	//=========================================================================
    public function IsValid()
    {
        return static::$is_valid;
    }

}
